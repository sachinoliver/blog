---
title: AWS IAM Exploitaion
author: Sachin
date: 2021-01-03 18:32:00 -0500
categories: [AWS Pentesting, AWS IAM Exploitation]
tags: [AWS, IAM]
---


## What is IAM?

In AWS `Identity and Access Management (IAM)` is a web service that helps you securely control access to AWS resources. You use IAM to control who is `authenticated (signed in)` and `authorized (has permissions)` to use resources.
It helps you set up users and groups, and shows you how to protect your resources with access control policies. It also shows how to connect to other identity services to grant external users access to your AWS resources.

So, a simple misconfiguration in IAM can lead to privilege escalation, which then can lead to furthur exploitations.

## Policies
The IAM uses policies (`JSON format`) for assigning actions for the users and roles which are attached to ceratin groups.
Services like `S3 bucket` for example have policy attached to them which allow users to do certain actions like listing bucket files or uploading files to the bucket etc.
Some services can have policies attached to them in the form of roles, that can be in the form of either a `service-linked roles`, where the service is granted to the role or having a role attached to a component in the service.

Policy is attached to a resource, such as a user account, EC2 instance, or internal AWS function, allowing that resource to make API calls to execute actions within the account. A policy that allows a user to retrieve objects from an S3 bucket may look like this:
```json
{
  "Effect": "Allow",
  "Action": [
    "s3:GetObject"
  ],
  "Resource": [
    "arn:aws:s3:::my-bucket/*"
  ]
}
```
### Types of IAM policies

    Identity-based policies
    Resource-based policies
    Permission boundaries
    Organizations service control policies (SCPs)
    Access control lists (ACLs)
    Session policies


## Overly-permissive IAM policies

If policies assigned in IAM permissions to a user, an attacker could use IAM API calls to elevate his privileges. 
Example:
Consider a AWS user Alice only has privileges to access IAM API calls, IAM:* for short
  Alice uses those privileges to create a new user: Bob
  Alice creates a new role with permissions to access all AWS services
  Alice assigns the newly created role to Bob
  Alice creates access keys for the user Bob


The permission set assigned to the user Bob would look like:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "*",
      "Resource": "*"
    }
  ]
}
```


To run this attack Alice requires at least these IAM permissions:
```
  CreateUser
  CreateAccessKey
  PutUserPolicy
```
It is important to notice that it would be also possible to achieve the same goal using other calls to the IAM
service, for example it is possible to create a group, assign the policy to that group and then make the newly
created user part of the groupÍ¾ or even make Alice part of the new group with high privileges.

`Dangerous permissions` for users fall within one of the following categories:

Policy attachment: the attacker can directly escalate their privileges by attaching a policy containing permissions higher than their own to their user, role, or a group of which their user is a member. Related permissions:
      > iam:PutGroupPolicy
      > iam:PutRolePolicy
      > iam:PutUserPolicy
      > iam:AttachGroupPolicy
      > iam:AttachRolePolicy
      > iam:AttachUserPolicy
       

Policy versioning: the attacker can create a new version of a policy attached to their user entity that has higher permission or they can revert their existing policy to an older version with more permissive/different grants. Related permissions:
     ```iam:CreatePolicyVersion
        iam:SetDefaultPolicyVersion
     ```
Group management: the attacker can move their user to a group that grants greater privileges. Related permissions:
     ```iam:AddUserToGroup
     ```

User Management: the attacker can create or change the console access credentials for another user then log into the console as that user or generate a new access key for another user then call the APIs directly. Related permissions:
     ```iam:CreateLoginProfile
        iam:UpdateLoginProfile
        iam:CreateAccessKey
     ```
  
  Service roles: the attacker can pass a privileged role to an AWS service then access its temporary credentials in order to perform privileged actions.

However, in practice, there are a larger number of combinations that could results in a user escalation (or, at least partially) based on the specific configurations present in the account.
