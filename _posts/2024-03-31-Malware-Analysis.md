---
title: Malware Analysis of Xworm
author: Sachin
date: 2024-03-31 14:10:00 +0800
categories: [Malware, Threat]
tags: [Malware, Analysis, .Net, Powershell]
render_with_liquid: false
---
# Xworm
![cover-1](https://github.com/sachinoliver/blog/assets/63084488/1a03948b-6266-439e-a7a8-a7fff9d6c65b)

`Xworm` represents a form of malware, targeting `Windows` systems. Upon infection, it can compromise the security of the system, potentially leading to data theft or unauthorized remote access. This type of malware poses significant risks to computer systems and underscores the importance of robust cybersecurity measures to prevent and mitigate such threats.


## Sample Collection
![image](https://github.com/sachinoliver/blog/assets/63084488/68595ca5-857c-4dd8-9069-bd6b03df63c8)

## Stage1
Extracted the sample from [`Malwarebazar`](https://bazaar.abuse.ch/sample/48abb729c4dd3419bbadd04d974a668d216d5513556d455bbd70dd3e2b723573/) with the password "infected".
The sample has an extension of .vbs, so dont run it, instead open with `notepad++`.

![notepad](https://github.com/sachinoliver/blog/assets/63084488/72f1f334-0195-4792-94fb-b3a54c266e6b)

Its a straightforward obfuscation. The function Tightness which takes the decimal value and return `ASCII`, which is (101) for letter 'e', and after `deobfuscation` and building the final URL, we can see proper clean code.

![note](https://github.com/sachinoliver/blog/assets/63084488/673c51f3-2e7d-42f7-814d-fb2ad66c12aa)


The code is trying to download and execute the content of the resource at the URL.

So lets curl the URL and get the file content downloaded... and it says 404 as of now the resource is not available at the URL
![image](https://github.com/sachinoliver/blog/assets/63084488/eaef3524-aa5c-4d0d-8051-32efe3f69e74)

So we have a problem here, while I am analysing the sample the content or the payload which needs to get downloaded during the execution of the above `vbs` script is no more available in the pastebin.... so how are we going to analyse it....!!!!

After searching a lot on the internet, I was not getting the same file from any sandbox or any Malware sample stores, So while I discussed the situation with my friend "[`Binary Panda`](https://binarypanda.me/)" who does similar stunts with malware, so we both where trying to find the sample in different `sandboxes`. Meanwhile, in one of the popular sandbox we saw there is a way to download pcap files for the sample which it has analyzed. That triggered a good idea!! Why can't we recreate the sample back from the pcap file!!!!

![image](https://github.com/sachinoliver/blog/assets/63084488/614384e7-3039-44f9-9d6d-5d9b9d08ec72)
Building the sample from the response header.

![image (2)](https://github.com/sachinoliver/blog/assets/63084488/df7787f8-4001-4246-bc22-1992a08b4060)

Yess!!! and that did solve our problem.

We recreated the sample from the dead just from the pcap file.  

Here begins our stage2 

## Stage2
Opened the file in `notepad++` again to see the contents of the file.
In this file, we can see a `powershell` command which is going to get executed when we open the file. 
![image (1)](https://github.com/sachinoliver/blog/assets/63084488/db485d6e-2e2a-40d3-902f-0740f05bdb90)

Below is the rest of the powershell script which is going to get executed. The script is executed with the Wscipt.exe process

![image](https://github.com/sachinoliver/blog/assets/63084488/a7c691a7-f6f1-4698-8899-8420ad36af96)


The above code is obfuscated, so after reading the last of the command `'DgTre'` is replaced with the letter `'A'`. So cleaned the code accordingly. The rest of the part is a base64 encoded string.
So decoded with `CyberChef`.

![cyberchef](https://github.com/sachinoliver/blog/assets/63084488/9b82b857-c80c-4cf4-b044-ed012c417cf7)


After decoding that we get a `powershell` script which needs some rearrangement.

![vscode](https://github.com/sachinoliver/blog/assets/63084488/f59fb93b-467c-4755-827e-fa6781a5b761)

Here is the clean `powershell` script.
So the what the script does is it retrieve data from a series of URLs. 

## Stage3

It scans the downloaded content for a segment delineated by `<<BASE64_START>>` and `<<BASE64_END>>` markers, presuming this portion to be base64-encoded. 

So here we have two URLs that need to be downloaded for further analysis.

But the file content is no longer available in the location!!
 
![planet](https://github.com/sachinoliver/blog/assets/63084488/3d893871-23ad-4ffd-91e7-cb3db6e0a86b)
The same thing happened here too the file is not present in the location, so we recreated it with PCAP file which we downloaded before.

After building the jpeg file, open it in a `HxD`

![hxd](https://github.com/sachinoliver/blog/assets/63084488/4e97ec10-2ce1-4d6c-83c1-1a12f830fce2) 



Seems like we need some cleaning to bring a real jpg file.

![steagno](https://github.com/sachinoliver/blog/assets/63084488/b6f6658c-c8fc-42aa-9792-67235a7da10c)
Nice isn't it...
Will Keep it as a Desktop Background xD


Now as per the powershell script, there are Flags `<<BASE64_START>>` and `<<BASE64_END>>` which we need to find from the file.
So seems like a sense of `steganography` technique is implemented here..
Let's find it in HxD 


![image](https://github.com/sachinoliver/blog/assets/63084488/941fe0e4-fbbb-4e29-b650-a056b1138efb)
![image](https://github.com/sachinoliver/blog/assets/63084488/80528826-d3dc-4d05-9d92-678d94b432bd)

Scrolling through the `HxD` we saw `<<BASE64_START>>` and `<<BASE64_END>>` flags.

So let's decode the base64 string in `Cyberchef`

![image](https://github.com/sachinoliver/blog/assets/63084488/4c581c2b-18bf-43cf-8e24-98abbda62d87)

While decoding we were able to see the magic bytes of an EXE file. So we save the output from Cyberchef.
Since it is an exe file, open it in `DIE (Detect it Easy)`

![image](https://github.com/sachinoliver/blog/assets/63084488/46b39a38-dbd1-4aba-a6bc-22aabfd5a477)

The file seems to be written in `.NET`
Let open it in `dnSpy`

![image](https://github.com/sachinoliver/blog/assets/63084488/08b1d7ae-23d5-499b-b1b4-dc5c2450314a)

## Persistence Technique
After searching through the .NET code, a method of ensuring persistence can be seen. This involves the program inserting itself into a registry key, enabling it to launch automatically upon each system startup. This persistence tactic helps the malware to maintain a foothold within the compromised system.

![image (5)](https://github.com/sachinoliver/blog/assets/63084488/fc45cf3b-b29f-4740-be87-84959f89599b)



![image (4)](https://github.com/sachinoliver/blog/assets/63084488/7633a68c-2ce0-422f-a965-9fada1ee13c7)



## IOCs:
```
hxxps://uploaddeimagens[.]com[.]br/images/004/739/227/original/new_image.jpg?1707826222
hxxp://45[.]74[.]19[.]84/xampp/bkp/vbs_novo_new_image[.]jpg
hxxps://wayoutkwt[.]com/bk/fexrw[.]txt
hxxps://pastebin[.]com/raw/G9zY5tnh
febxworm39090[.]duckdns[.]org
45[.]74[.]19[.]84
85673635.vbs — 032c2cc1862303d06832c0ebe34b9dae
PROJETOAUTOMACAO.VB1.dll — ce91eb459e4f6a9e2871088d855cd211
febxworm39090.exe — 1a2b23fd06525561826e61fc104b66d0
vbs_novo_new_image.jpg — ddb09774c5a870c73cf0cf71e6d97d3e
output.273230999.txt — 983865b130c91b9b3a36d488afbdd1bd
```





