---
title: Malware Analysis of Xworm
author: Sachin
date: 2024-03-31 14:10:00 +0800
categories: [Malware, Threat]
tags: [Malware, Analysis, .Net, Powershell]
render_with_liquid: false
---
## Xworm
![cover-1](https://github.com/sachinoliver/blog/assets/63084488/1a03948b-6266-439e-a7a8-a7fff9d6c65b)

So Xworm represents a form of malware designed to propagate via removable drives like USB flash drives, targeting Windows systems. Upon infection, it can compromise the security of the system, potentially leading to data theft or unauthorized remote access. This type of malware poses significant risks to computer systems and underscores the importance of robust cybersecurity measures to prevent and mitigate such threats.

![image](https://github.com/sachinoliver/blog/assets/63084488/794c625e-5481-4e8d-8854-477af1e97510)

Download and extracted this sample from Malwarebazar with the password "infected"
The sample is having a extenstion of .vbs, so tried opening it on a notepad++.

![notepad](https://github.com/sachinoliver/blog/assets/63084488/72f1f334-0195-4792-94fb-b3a54c266e6b)

It initially appeared to be a straightforward deobfuscation task.


The deobfuscation process appeared straightforward, with the initial function returning characters based on specified ASCII codes.
Also letter 'e' is the one missing from the past'e'bin. So after deobfuscation and building the final Url we are able to see a proper clean code.

![note](https://github.com/sachinoliver/blog/assets/63084488/673c51f3-2e7d-42f7-814d-fb2ad66c12aa)


The code is trying to download the contents of the url and trying to execute the content of the Url.

So lets curl the url and get the file downloaded...

when i did curl and saved the file to a 'out' file. When i checked the file, the file is just an html file saying the content  no more available.

Wait wait , So we have a propblem here, while i am analysing the sample the content or the payload which need to get downloaded during the execution of the above vbs script is no more availble in the pastebin.... so how are we going to analyse it....!!!!

After seraching alot on internet, i was not getting the same file from any sandbox or from any Malware sample stores, So while i discussed the situcation with my friend "Binary Panda" who does similiar stunts with malware, so we both where trying to find the sample in different sandboxes. Meanwhile we saw in one of the popular sandbox we say there is way to download pcap files for the sample which it has analysed. That triggered a good idea!! Why cant we recreate the sample back from the pcap file!!!!
![image (2)](https://github.com/sachinoliver/blog/assets/63084488/df7787f8-4001-4246-bc22-1992a08b4060)

Yess!!! and that did solve our problem.

We recreated the sample from the dead just from the pcap file.  

Here begins our stage2 
### Stage2
Opened the file in notepad++ again to see the contents of the file.
In this file we can see a powershell command which is going to get executed when we open the file. 
![image (1)](https://github.com/sachinoliver/blog/assets/63084488/db485d6e-2e2a-40d3-902f-0740f05bdb90)

Below is the rest of the powershell script which is going to get executed. The script is getting executed with the Wscipt.exe process

![power](https://github.com/sachinoliver/blog/assets/63084488/4f920486-14d6-4e6c-8fd3-f9a190a1d843)

The above code is obfuscated, so after reading the last of the command 'DgTre' is being replaced with letter 'A'. So cleaned the code accordingly. Then rest of the part is a base64 encoded string.
So decoded with CyberChef.

![cyberchef](https://github.com/sachinoliver/blog/assets/63084488/9b82b857-c80c-4cf4-b044-ed012c417cf7)


After decoding that we get a powershell script which needs some rearrangement.

![vscode](https://github.com/sachinoliver/blog/assets/63084488/f59fb93b-467c-4755-827e-fa6781a5b761)

Here is the clean powershell script.
So the what the script does is it retrieve data from a series of URLs. 
It scans the downloaded content for a segment delineated by <<BASE64_START>> and <<BASE64_END>> markers, presuming this portion to be base64-encoded. 

So here we have two Urls that need to be downloaded for further analysis.

But the file content is no more available in the location!!
 
![planet](https://github.com/sachinoliver/blog/assets/63084488/3d893871-23ad-4ffd-91e7-cb3db6e0a86b)
Same thing happnens here too the file is not present in the localtion, so we recreate it with PCAP file which we downloaded before.

After building the jpeg file, opened it in a HxD

![hxd](https://github.com/sachinoliver/blog/assets/63084488/4e97ec10-2ce1-4d6c-83c1-1a12f830fce2) 



Seems like we need to cleaning needed for bringing to a real jpeg file.
Now as per the powershell script there are Flags <<BASE64_START>> and <<BASE64_END>> which we need to find from the file.
So seems like a sense of steganography technique implemented here...|
Lets find it in HxD 


![image](https://github.com/sachinoliver/blog/assets/63084488/941fe0e4-fbbb-4e29-b650-a056b1138efb)
![image](https://github.com/sachinoliver/blog/assets/63084488/80528826-d3dc-4d05-9d92-678d94b432bd)

Scrolling throught the HxD we saw <<BASE64_START>> and <<BASE64_END>> flags. 

So lets decode the base64 string in Cyberchef
![image](https://github.com/sachinoliver/blog/assets/63084488/4c581c2b-18bf-43cf-8e24-98abbda62d87)

While decoding we where able to see magic bytes of a EXE file. So we save the output from Cyberchef.
Since its exe file  opened it in DIE (Detect it Easy)

![image](https://github.com/sachinoliver/blog/assets/63084488/46b39a38-dbd1-4aba-a6bc-22aabfd5a477)

The file seems to be written in .NET.
Let open it in dnSpy

![steagno](https://github.com/sachinoliver/blog/assets/63084488/b6f6658c-c8fc-42aa-9792-67235a7da10c)


Nice isnt it...
Will Keep as a Desktop Banckground xD

